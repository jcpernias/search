---
title: "Search"
author: "José C. Pernías"
date: "23/12/2016"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = " ")
library(tidyverse)
library(broom)
library(knitr)
```

## Data

The variables are stored in three files: one for treatment design variables, `./data/treatments.csv`; another for lotteries results, `./data/subjects.csv`; and, finally, one for prices, `./data/prices.csv`.

### Treatment design variables
```{r}
treat_db <- read_csv('./data/treatments.csv', col_types = "ilii")
kable(treat_db, align = "cccc")
```

Variables:

- `treat_id`: the treatment id; an integer.
- `biased`: true if the treatment's search engine is biased; a logical. 
- `n`: number of firms in the market; an integer.
- `k`: number of firms in the index, $k \leq n$; an integer.

### Lotteries results
```{r}
subjects_db <- read_csv('./data/subjects.csv', col_types = "idddd")
glimpse(subjects_db)
```

Variables:

- `subject_id`: the subject id; an integer.
- `p1, p2, p3, p4`: subject's lottery choices in each of the four panels; a double between 0.0 an 1.0. 


### Prices 
```{r}
prices_db <- read_csv('./data/prices.csv', col_types = "iiiild")
glimpse(prices_db)
```

Variables:

- `treat_id`: treatment id; an integer.
- `market_id`: market id; an integer.
- `period`: time period; an integer.
- `subject_id`: subject id; an integer.
- `indexed`: true if the price is included in the index; a logical.
- `price`: the price; a double between 0.0 and 1.0.

## Results

### Sample

The first 20 periods are dropped from the sample. Two new price variables:

- Selectable prices: all prices from unbiased treatments and those from indexed firms in biased treatments.
- Indexed prices: only the prices finally appearing in the index.

```{r}
smpl <- left_join(prices_db, treat_db, by = 'treat_id') %>% 
  filter(period > 20) %>%
  mutate(pselect = if_else(!biased | indexed, price, NA_real_),
         pindex = if_else(indexed, price, NA_real_))

markets <- smpl %>% group_by(market_id) %>%
  summarise(treat = first(treat_id),
            period = first(period),
            pavg = mean(pselect, na.rm = TRUE),
            pmin = min(pindex, na.rm = TRUE)) %>%
  mutate(group = as.integer(floor((period  - 1) / 10) - 1))

dstats <- markets %>% group_by(treat) %>%
  summarise('Avg p: mean' = mean(pavg),
            'Avg p: sd' = sd(pavg),
            'Min p: mean' = mean(pmin),
            'MIn p: sd' = sd(pmin))

kable(dstats, digits = 3)

```

```{r}
markets %>% group_by(treat) %>% 
  do(tidy(kruskal.test(pavg ~ group, data = .))) %>%
  select(-method)
```

```{r}
filter(markets, group != 2) %>% group_by(treat) %>% 
  do(tidy(kruskal.test(pavg ~ group, data = .))) %>%
  select(-method)
```

```{r}
markets %>% group_by(treat) %>% 
  do(tidy(cor.test(~ pavg + period, method = "kendall", data = .))) %>%
  select(-one_of(c("method", "alternative")))
```
